<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ğŸšš Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ â€” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root{
    --violet:#5b21b6; --violet-600:#7c3aed;
    --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
    --blue:#2563eb; --green:#16a34a; --yellow:#f59e0b; --purple:#a855f7; --red:#ef4444; --gray:#94a3b8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:"Cairo",sans-serif;background:var(--bg);color:var(--ink);overflow:hidden}

  /* ===== Login ===== */
  #loginView{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:22px;background:linear-gradient(135deg,#5b21b6,#7c3aed,#4c1d95)}
  .login-card{width:min(440px,92vw);background:#fff;border-radius:18px;padding:24px;text-align:center;box-shadow:0 22px 50px rgba(0,0,0,.28)}
  .logo{width:78px;height:78px;border-radius:999px;margin:0 auto 8px;display:grid;place-items:center;background:#efeaff;color:#7c3aed;font-size:36px}
  .login-card h1{margin:2px 0 4px}
  .login-card small{color:var(--muted)}
  .grp{text-align:right;margin-top:12px}
  .grp label{font-weight:800;font-size:14px;margin-bottom:6px;display:block}
  .inp{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:15px}
  .inp:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px #7c3aed26}
  .btn{width:100%;margin-top:14px;padding:12px 14px;border:0;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#5b21b6);color:#fff;font-weight:800;cursor:pointer}

  /* ===== App Layout ===== */
  #app{display:none;min-height:100vh}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);
         display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
  .title{font-weight:800;font-size:22px}
  .menubtn{border:1px solid var(--border);background:#7c3aed;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

  /* Sidebar */
  .side{position:fixed;top:0;right:-310px;width:300px;height:100%;background:#0f1020;color:#fff;padding:20px 16px;overflow-y:auto;transition:right .28s;z-index:150}
  .side.open{right:0}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:140}
  .overlay.show{display:block}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:4px}
  .brand .ic{font-size:28px}
  .brand h2{margin:0;font-size:22px;font-weight:800}
  .hello{color:#facc15;margin:6px 0 14px 0;font-weight:800}
  .menu{display:flex;flex-direction:column;gap:10px}
  .menu button{background:#191a3a;border:0;color:#fff;border-radius:12px;padding:14px 12px;text-align:right;font-weight:800;cursor:pointer}
  .menu button.active,.menu button:hover{background:#242558}
  .menu .logout{background:linear-gradient(135deg,#ef4444,#b91c1c)}

  /* Content */
  main{height:calc(100vh - 56px);overflow:auto;padding:12px}

  /* KPI box */
  .kbox{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;max-width:520px}
  .krow{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #eef2f7;
        padding:10px 12px;border-radius:12px;margin:10px 0;font-weight:800}

  /* Pills & counts */
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .pill{border:0;border-radius:999px;padding:9px 12px;color:#fff;font-weight:800;cursor:pointer}
  .pill.all{background:#334155}.pill.exec{background:var(--blue)}.pill.temp{background:var(--yellow);color:#111}
  .pill.done{background:var(--green)}.pill.post{background:var(--purple)}.pill.reject{background:var(--red)}
  .counts{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 8px}
  .count{background:#fff;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:800;font-size:12px}

  /* Grid & order cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 10px 22px rgba(0,0,0,.06);border:1px solid #eef2f7}
  .order{color:#fff;border:0}
  .exec{background:#2563eb} .temp{background:#f59e0b;color:#111}
  .done{background:#16a34a} .post{background:#a855f7}
  .reject{background:#ef4444} .arch{background:#94a3b8}
  .order h4{margin:0 0 8px;font-size:18px;font-weight:800}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .chip{background:#ffffff22;color:#fff;border-radius:10px;padding:6px 8px;font-size:13px}
  .meta{font-size:12px;margin-top:8px;opacity:.95}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btnx{background:#00000020;border:0;color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}

  /* Search */
  .search-line{display:flex;gap:8px;align-items:center}
  .search-line input{flex:1}

  /* Toast */
  .toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.28);display:none;z-index:300;font-weight:800}
</style>
</head>
<body>

<!-- ===== Login ===== -->
<section id="loginView">
  <div class="login-card">
    <div class="logo">ğŸšš</div>
    <h1>Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ</h1>
    <small>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</small>
    <div class="grp"><label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¯Ø®ÙˆÙ„</label><input id="lgUser" class="inp" placeholder="Ù…Ø«Ø§Ù„: ahm26377"></div>
    <div class="grp"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="lgPass" class="inp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <button class="btn" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <div style="color:#7c3aed;font-weight:800;margin-top:6px">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© mandoubs</div>
  </div>
</section>

<!-- ===== App ===== -->
<section id="app">
  <header>
    <span class="title" id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    <button class="menubtn" id="menuBtn">â˜°</button>
  </header>

  <!-- Sidebar -->
  <aside class="side" id="sidebar">
    <div class="brand"><div class="ic">ğŸšš</div><h2>Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ</h2></div>
    <div class="hello" id="helloName">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
    <nav class="menu">
      <button data-view="home" class="active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button data-view="orders">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button data-view="search">ğŸ” Ø§Ù„Ø¨Ø­Ø«</button>
      <button data-view="archive">ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
      <button data-view="notifications">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
      <button data-view="support">ğŸ†˜ Ø§Ù„Ø¯Ø¹Ù…</button>
      <button class="logout" id="btnLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </nav>
  </aside>
  <div class="overlay" id="overlay"></div>

  <main>
    <!-- Home -->
    <div id="home" class="page">
      <h2 style="margin:4px 0 8px">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="welcomeName">â€”</span></h2>
      <h3 style="margin:0 0 10px">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
      <div class="kbox">
        <div class="krow"><span>Ø¹Ø¯Ø¯ (ÙˆØ§ØµÙ„):</span><b id="kCount">0</b></div>
        <div class="krow"><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</span><b id="kTotal">0</b></div>
        <div class="krow"><span>Ø§Ù„Ø£Ø¬ÙˆØ± (1000/Ø·Ù„Ø¨):</span><b id="kFees">0</b></div>
        <div class="krow"><span>Ø§Ù„ØµØ§ÙÙŠ:</span><b id="kNet">0</b></div>
      </div>
    </div>

    <!-- Orders -->
    <div id="orders" class="page" style="display:none">
      <h2 style="margin:4px 0 10px">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
      <div class="filters">
        <button class="pill all"   data-key="all">Ø§Ù„ÙƒÙ„</button>
        <button class="pill exec"  data-key="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
        <button class="pill temp"  data-key="temp">Ù…Ø¤Ù‚Øª</button>
        <button class="pill done"  data-key="delivered">ÙˆØ§ØµÙ„</button>
        <button class="pill post"  data-key="delayed">Ù…Ø¤Ø¬Ù„</button>
        <button class="pill reject"data-key="rejected">Ø±ÙØ¶</button>
      </div>
      <div class="counts">
        <div class="count">Ù‚ÙŠØ¯: <b id="cnt-pending">0</b></div>
        <div class="count">Ù…Ø¤Ù‚Øª: <b id="cnt-temp">0</b></div>
        <div class="count">Ù…Ø¤Ø¬Ù„: <b id="cnt-delayed">0</b></div>
        <div class="count">ÙˆØ§ØµÙ„: <b id="cnt-delivered">0</b></div>
        <div class="count">Ø±ÙØ¶: <b id="cnt-rejected">0</b></div>
      </div>
      <div id="ordersWrap" class="grid"></div>
    </div>

    <!-- Search -->
    <div id="search" class="page" style="display:none">
      <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø«</h2>
      <div class="card search-line">
        <input id="q" class="inp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø´Ø±ÙƒØ©">
        <button class="btn" id="btnSearch" style="width:auto;padding:10px 14px">Ø¨Ø­Ø«</button>
      </div>
      <div id="searchWrap" class="grid" style="margin-top:10px"></div>
    </div>

    <!-- Archive -->
    <div id="archive" class="page" style="display:none">
      <h2>ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h2>
      <div id="archWrap" class="grid"></div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="page" style="display:none">
      <h2>ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
      <div id="notifList" class="grid"></div>
    </div>

    <!-- Support -->
    <div id="support" class="page" style="display:none">
      <h2>ğŸ†˜ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2>
      <div class="grid">
        <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div><div style="font-weight:800">ØºÙØ§Ø±</div><div class="muted">ğŸ“ 07810433473</div></div>
          <div style="display:flex;gap:8px">
            <a href="tel:07810433473" class="btn" style="background:#16a34a">Ø§ØªØµØ§Ù„</a>
            <a href="https://wa.me/9647810433473" target="_blank" class="btn" style="background:#25d366">ÙˆØ§ØªØ³Ø§Ø¨</a>
          </div>
        </div>
        <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div><div style="font-weight:800">Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…</div><div class="muted">ğŸ“ 07823789656</div></div>
          <div style="display:flex;gap:8px">
            <a href="tel:07823789656" class="btn" style="background:#16a34a">Ø§ØªØµØ§Ù„</a>
            <a href="https://wa.me/9647823789656" target="_blank" class="btn" style="background:#25d366">ÙˆØ§ØªØ³Ø§Ø¨</a>
          </div>
        </div>
      </div>
    </div>
  </main>
</section>

<div id="toast" class="toast"></div>
<audio id="notifBeep" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAACAA"></audio>

<!-- ===== Firebase v10 ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc,
    onSnapshot, serverTimestamp, orderBy
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  /* Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyDmTFz_jU3HF8Jgb5wbpx_xtGvjBTPksOY",
    authDomain: "bagdadi-delivery.firebaseapp.com",
    projectId: "bagdadi-delivery",
    storageBucket: "bagdadi-delivery.appspot.com",
    messagingSenderId: "957413017368",
    appId: "1:957413017368:web:a9c7373f0cf3e95cbc806d"
  };
  const appFB = initializeApp(firebaseConfig);
  const db = getFirestore(appFB);

  /* DOM helpers */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const overlay = $('#overlay'), sidebar = $('#sidebar'), menuBtn = $('#menuBtn');
  const toast = $('#toast'), beep = $('#notifBeep');
  const pageTitle = $('#pageTitle');
  const en = n => Number(n||0).toLocaleString('en-US');
  const fmtTime = (ts)=>{
    const d = (ts?.toDate?.() ? ts.toDate() : (ts?new Date(ts):new Date()));
    let h=d.getHours(), m=String(d.getMinutes()).padStart(2,'0'), ap=h>=12?'Ù…':'Øµ';
    let hh=h%12||12; return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} â€” ${hh}:${m} ${ap}`;
  };

  /* Session + caches */
  let MAND = null;          // {id,user,name}
  let ALL = [];             // orders (live/cache)
  let ARCH = [];            // archive (live/cache)
  const WAGE = 1000;

  /* ===== Restore session immediately ===== */
  try{
    const s = localStorage.getItem('mandoub');
    if(s){
      MAND = JSON.parse(s);
      /* show cached data instantly (offline-first) */
      try{
        const oc = localStorage.getItem('orders_cache'); if(oc){ ALL = JSON.parse(oc); }
        const ac = localStorage.getItem('archive_cache'); if(ac){ ARCH = JSON.parse(ac); }
      }catch{}
      enterApp(true);  // true => came from restore
    }
  }catch{}

  /* ===== Login ===== */
  async function doLogin(){
    const user = $('#lgUser').value.trim().toLowerCase();
    const pass = $('#lgPass').value.trim();
    if(!user||!pass){ Swal.fire({icon:'warning',title:'ØªÙ†Ø¨ÙŠÙ‡',text:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'}); return; }
    try{
      const qs = await getDocs(query(collection(db,'mandoubs'), where('user','==',user), where('password','==',pass)));
      if(qs.empty){ Swal.fire({icon:'error',title:'Ø®Ø·Ø£',text:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'}); return; }
      const d = qs.docs[0]; const m = d.data();
      MAND = { id:d.id, user:m.user, name:m.name||m.user };
      localStorage.setItem('mandoub', JSON.stringify(MAND));
      enterApp(false);
    }catch(e){
      console.error(e);
      Swal.fire({icon:'error',title:'Ø®Ø·Ø£ Ø§ØªØµØ§Ù„',text:e.message});
    }
  }
  $('#btnLogin').addEventListener('click', doLogin);
  window.addEventListener('keydown', e=>{ if(e.key==='Enter' && $('#loginView').style.display!=='none') doLogin(); });

  /* ===== Enter App ===== */
  function enterApp(restored){
    $('#loginView').style.display='none';
    $('#app').style.display='block';
    $('#helloName').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${MAND.name}`;
    $('#welcomeName').textContent = MAND.name;

    // paint immediately from cache if exists
    setActive('home', false);
    refreshKPI();
    renderOrders();
    renderArchive();

    // then attach live listeners (auto-update)
    mountRealtime();
    loadArchive();
    startNotifListener();
  }

  /* ===== Navigation + sidebar ===== */
  function setActive(view, push=true){
    $$('.page').forEach(p=>p.style.display='none');
    $(`#${view}`).style.display='block';
    $$('.menu button[data-view]').forEach(b=>b.classList.remove('active'));
    $(`.menu button[data-view="${view}"]`)?.classList.add('active');
    pageTitle.textContent = (
      view==='home'?'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©':
      view==='orders'?'Ø§Ù„Ø·Ù„Ø¨Ø§Øª':
      view==='search'?'Ø§Ù„Ø¨Ø­Ø«':
      view==='archive'?'Ø§Ù„Ø£Ø±Ø´ÙŠÙ':
      view==='notifications'?'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª':'Ø§Ù„Ø¯Ø¹Ù…'
    );
    if(view==='orders') renderOrders();
    if(view==='archive') renderArchive();
    if(view==='home') refreshKPI();
    if(view==='notifications') renderNotifsHistory();
  }
  menuBtn.addEventListener('click', ()=>{ sidebar.classList.add('open'); overlay.classList.add('show'); });
  overlay.addEventListener('click', ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('show'); });
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.menu button[data-view]');
    if(btn){ sidebar.classList.remove('open'); overlay.classList.remove('show'); setActive(btn.dataset.view); }
  });

  /* ===== Logout (no deletion) ===== */
  $('#btnLogout').addEventListener('click', ()=>{
    Swal.fire({icon:'question',title:'ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',text:'Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙ‚Ø·ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ù‚Ù‰ Ù…Ø­ÙÙˆØ¸Ø©',showCancelButton:true,confirmButtonText:'Ù†Ø¹Ù…',cancelButtonText:'Ù„Ø§'})
    .then(r=>{
      if(r.isConfirmed){
        // Ù„Ø§ Ù†Ø­Ø°Ù Ù„Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ„Ø§ Ø§Ù„ÙƒØ§Ø´ â€” ÙÙ‚Ø· Ù†Ø±Ø¬Ø¹ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        $('#app').style.display='none';
        $('#loginView').style.display='flex';
      }
    });
  });

  /* ===== Realtime Orders (auto-cache) ===== */
  let unsubOrders=null;
  function mountRealtime(){
    if(unsubOrders) unsubOrders();
    const q1 = query(collection(db,'orders'), where('mandoubId','==', MAND.id));
    unsubOrders = onSnapshot(q1,(snap)=>{
      const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      arr.sort((a,b)=> (b.lastUpdate?.seconds||b.createdAt?.seconds||0) - (a.lastUpdate?.seconds||a.createdAt?.seconds||0));
      ALL = arr;

      // cache locally (persists across refresh/logout)
      try{ localStorage.setItem('orders_cache', JSON.stringify(arr)); }catch{}

      refreshKPI();
      if($('#orders').style.display!=='none') renderOrders();
      if($('#search').style.display!=='none') doSearch();
    }, (err)=>console.error('orders snapshot error', err));
  }

  /* ===== Archive (auto-cache) ===== */
  async function loadArchive(){
    try{
      const qs = await getDocs(query(collection(db,'archive'), where('mandoubId','==', MAND.id)));
      const list=[]; qs.forEach(d=>list.push({id:d.id, archived:true, ...d.data()}));
      ARCH = list;

      try{ localStorage.setItem('archive_cache', JSON.stringify(list)); }catch{}

      if($('#archive').style.display!=='none') renderArchive();
    }catch(e){
      console.error(e);
      // fallback to cache if offline
      try{
        const cache = localStorage.getItem('archive_cache');
        if(cache){ ARCH = JSON.parse(cache); if($('#archive').style.display!=='none') renderArchive(); }
      }catch{}
    }
  }

  /* ===== KPI (delivered only) ===== */
  function refreshKPI(){
    const delivered = ALL.filter(o=>o.status==='delivered');
    const count = delivered.length;
    const total = delivered.reduce((s,o)=> s + Number(o.amount||0), 0);
    const fees = count*WAGE, net = total - fees;
    $('#kCount').textContent = String(count);
    $('#kTotal').textContent = en(total);
    $('#kFees').textContent  = en(fees);
    $('#kNet').textContent   = en(net);
  }

  /* ===== Helpers ===== */
  const sClass = s => (s==='pending'?'exec': s==='temp'?'temp': s==='delivered'?'done': s==='delayed'?'post': s==='rejected'?'reject':'exec');
  const sText  = s => ({pending:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', temp:'Ù…Ø¤Ù‚Øª', delivered:'ÙˆØ§ØµÙ„', delayed:'Ù…Ø¤Ø¬Ù„', rejected:'Ø±ÙØ¶'})[s]||s;

  /* ===== Order card + actions (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨) ===== */
  function orderCard(o){
    const div = document.createElement('div');
    const cls = sClass(o.status);
    div.className = `card order ${cls}`;
    const when = o.lastUpdate ? fmtTime(o.lastUpdate) : (o.createdAt? fmtTime(o.createdAt) : 'â€”');

    let actions = '';
    if(o.status==='pending'){
      actions = `
        <button class="btnx" data-act="delivered">âœ… ÙˆØ§ØµÙ„</button>
        <button class="btnx" data-act="delay">â³ Ù…Ø¤Ø¬Ù„</button>
        <button class="btnx" data-act="reject">âŒ Ø±ÙØ¶</button>
      `;
    }else if(o.status==='delayed'){
      actions = `
        <button class="btnx" data-act="delivered">âœ… ÙˆØ§ØµÙ„</button>
        <button class="btnx" data-act="reject">âŒ Ø±ÙØ¶</button>
      `;
    }else if(o.status==='rejected'){
      actions = `
        <button class="btnx" data-act="delivered">âœ… ÙˆØ§ØµÙ„</button>
        <button class="btnx" data-act="delay">â³ Ù…Ø¤Ø¬Ù„</button>
      `;
    }

    div.innerHTML = `
      <h4>ÙˆØµÙ„: ${o.wasl||'-'} â€” ${o.company||'-'}</h4>
      <div class="row">
        <span class="chip">ğŸ“± ${o.phone||'-'}</span>
        <span class="chip">ğŸ™ï¸ ${o.gov||'-'} â€¢ ${o.area||'-'}</span>
        <span class="chip">ğŸ’µ ${en(o.amount||0)}</span>
        <span class="chip">ğŸ“Œ ${sText(o.status||'pending')}</span>
      </div>
      ${o.managerNote? `<div class="row" style="margin-top:4px"><span class="chip" style="background:#ffffff33">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ${o.managerNote}</span></div>`:''}
      ${o.reason? `<div class="row" style="margin-top:4px"><span class="chip" style="background:#ffffff33">ğŸ“Œ Ø³Ø¨Ø¨: ${o.reason}${o.newAmount?` â€” Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯ ${en(o.newAmount)}`:''}</span></div>`:''}
      ${actions? `<div class="actions">${actions}</div>`:''}
      <div class="meta">ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${when}</div>
    `;
    div.querySelectorAll('.actions .btnx').forEach(b=>{
      b.addEventListener('click', ()=> handleAction(o, b.dataset.act));
    });
    return div;
  }

  /* ===== Counters + render ===== */
  function paintCounters(){
    const counts = {pending:0,temp:0,delayed:0,delivered:0,rejected:0};
    ALL.forEach(o=>counts[o.status]=(counts[o.status]||0)+1);
    $('#cnt-pending').textContent=counts.pending||0;
    $('#cnt-temp').textContent=counts.temp||0;
    $('#cnt-delayed').textContent=counts.delayed||0;
    $('#cnt-delivered').textContent=counts.delivered||0;
    $('#cnt-rejected').textContent=counts.rejected||0;
  }
  function renderOrders(filter=null){
    const wrap = $('#ordersWrap'); wrap.innerHTML='';
    paintCounters();
    let list = ALL.slice();
    if(filter && filter!=='all'){ list = list.filter(o=>o.status===filter); }
    if(!list.length){ wrap.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>`; return; }
    list.forEach(o=> wrap.appendChild(orderCard(o)));
  }
  $$('#orders .filters .pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      $$('#orders .filters .pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      const key=p.dataset.key;
      renderOrders(key==='all'?null:key);
    });
  });

  /* ===== Search (ALL + ARCH) ===== */
  $('#btnSearch').addEventListener('click', doSearch);
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
  function doSearch(){
    const k = $('#q').value.trim().toLowerCase();
    const wrap = $('#searchWrap'); wrap.innerHTML='';
    if(!k){ return; }
    const src = [...ALL, ...ARCH];
    const res = src.filter(o=>
      String(o.wasl||'').toLowerCase().includes(k) ||
      String(o.phone||'').toLowerCase().includes(k) ||
      String(o.company||'').toLowerCase().includes(k)
    );
    if(!res.length){ wrap.innerHTML=`<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`; return; }
    res.forEach(o=>{
      const c = document.createElement('div');
      const cls = o.archived ? 'arch' : sClass(o.status);
      c.className = `card order ${cls}`;
      c.innerHTML = `
        <h4>ÙˆØµÙ„: ${o.wasl||'-'} â€” ${o.company||'-'}</h4>
        <div class="row">
          <span class="chip">ğŸ“± ${o.phone||'-'}</span>
          <span class="chip">ğŸ™ï¸ ${o.gov||'-'} â€¢ ${o.area||'-'}</span>
          <span class="chip">ğŸ’µ ${en(o.amount||0)}</span>
        </div>
        <div class="meta">${o.archived?'ğŸ—„ï¸ Ø£Ø±Ø´ÙŠÙ':'ğŸ“Œ '+sText(o.status)}</div>
      `;
      wrap.appendChild(c);
    });
  }

  /* ===== Archive render ===== */
  function renderArchive(){
    const wrap = $('#archWrap'); wrap.innerHTML='';
    if(!ARCH.length){ wrap.innerHTML = `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ.</div>`; return; }
    ARCH.forEach(o=>{
      const c = document.createElement('div');
      c.className='card order arch';
      const when = o.lastUpdate ? fmtTime(o.lastUpdate) : (o.createdAt? fmtTime(o.createdAt) : 'â€”');
      c.innerHTML = `<h4>ÙˆØµÙ„: ${o.wasl||'-'} â€” ${o.company||'-'}</h4>
        <div class="row">
          <span class="chip">ğŸ“± ${o.phone||'-'}</span>
          <span class="chip">ğŸ’µ ${en(o.amount||0)}</span>
        </div>
        <div class="meta">ğŸ—„ï¸ Ø£Ø±Ø´ÙŠÙ â€¢ ${when}</div>`;
      wrap.appendChild(c);
    });
  }

  /* ===== Actions (no delete from mandoub) ===== */
  async function handleAction(o, act){
    try{
      if(act==='delivered'){
        const ok = await Swal.fire({title:'ØªØ£ÙƒÙŠØ¯',text:'ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©: ÙˆØ§ØµÙ„ØŸ',icon:'question',showCancelButton:true,confirmButtonText:'Ù†Ø¹Ù…'});
        if(!ok.isConfirmed) return;
        await updateDoc(doc(db,'orders',o.id), {
          status:'delivered', deliveredAt:serverTimestamp(), lastUpdate:serverTimestamp(),
          mandoub: MAND.user, mandoubName: MAND.name, mandoubId: MAND.id
        });
        await notifyManagers('status_change','ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙˆØ§ØµÙ„',`Ø·Ù„Ø¨ ${o.wasl||o.id} Ø£ØµØ¨Ø­ ÙˆØ§ØµÙ„`);
        showToast(`âœ… Ø´ÙƒØ±Ø§Ù‹ ÙƒØ§Ø¨ØªÙ† ${MAND.name}`);
      }
      else if(act==='delay'){
        const ok = await Swal.fire({title:'ØªØ£ÙƒÙŠØ¯',text:'ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø¤Ø¬Ù„ØŸ',icon:'question',showCancelButton:true,confirmButtonText:'Ù†Ø¹Ù…'});
        if(!ok.isConfirmed) return;
        await updateDoc(doc(db,'orders',o.id), { status:'delayed', lastUpdate:serverTimestamp() });
        await notifyManagers('status_change','ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù…Ø¤Ø¬Ù„',`Ø·Ù„Ø¨ ${o.wasl||o.id} Ø£ØµØ¨Ø­ Ù…Ø¤Ø¬Ù„`);
        Swal.fire('ØªÙ…','ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¤Ø¬Ù„)','success');
      }
      else if(act==='reject'){
        const {value:reason} = await Swal.fire({
          title:'Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶', input:'select', inputPlaceholder:'Ø§Ø®ØªØ± Ø³Ø¨Ø¨',
          inputOptions:{
            'Ù„Ø§ ÙŠØ±Ø¯':'Ù„Ø§ ÙŠØ±Ø¯','Ù„Ø§ÙŠØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚':'Ù„Ø§ÙŠØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚','Ù…ØºÙ„Ù‚':'Ù…ØºÙ„Ù‚','Ù…ØºÙ„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚':'Ù…ØºÙ„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚',
            'Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø·Ù„Ø¨':'Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø·Ù„Ø¨','Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù‚ÙŠØ§Ø³':'Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù‚ÙŠØ§Ø³','Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù„ÙˆÙ†':'Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù„ÙˆÙ†',
            'Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨':'Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨','ØªØºÙŠØ± Ø³Ø¹Ø±':'ØªØºÙŠØ± Ø³Ø¹Ø±'
          }, showCancelButton:true, confirmButtonText:'ØªØ£ÙƒÙŠØ¯'
        });
        if(!reason) return;
        let updates = { status:'rejected', reason, lastUpdate:serverTimestamp() };
        if(reason==='ØªØºÙŠØ± Ø³Ø¹Ø±'){
          const {value:newPrice} = await Swal.fire({title:'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯', input:'number', inputAttributes:{min:0}, showCancelButton:true});
          if(!newPrice && newPrice!==0) return;
          updates.newAmount = Number(newPrice);
        }
        await updateDoc(doc(db,'orders',o.id), updates);
        await notifyManagers('status_change','ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø±ÙØ¶',`Ø·Ù„Ø¨ ${o.wasl||o.id} â€” Ø³Ø¨Ø¨: ${reason}`);
        Swal.fire('ØªÙ…','ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© (Ø±ÙØ¶)','success');
      }
    }catch(e){ console.error(e); Swal.fire({icon:'error',title:'Ø®Ø·Ø£',text:'ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'}); }
  }

  async function notifyManagers(type, title, message){
    try{
      await addDoc(collection(db,'notifications'),{
        type, title, message, by: MAND.name, mandoub: MAND.user, mandoubId: MAND.id,
        roleTarget:'manager', to:'managers', at: serverTimestamp(), seen:false
      });
    }catch(e){ console.error('notify error', e); }
  }

  /* ===== Live notifications for mandoub (and cache not needed) ===== */
  let unsubMyNotifs=null;
  function startNotifListener(){
    if(unsubMyNotifs) unsubMyNotifs();
    unsubMyNotifs = onSnapshot(query(collection(db,'notifications'), orderBy('at','desc')),(snap)=>{
      snap.docChanges().forEach(ch=>{
        if(ch.type!=='added') return;
        const n = ch.doc.data();
        const hits = (n.to && MAND.id && n.to===MAND.id) || /mandoub/.test(n.roleTarget||'');
        if(hits){ try{beep.currentTime=0; beep.play();}catch{} showToast(n.title||'ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯'); appendNotifCard(n,true); }
      });
    });
  }
  async function renderNotifsHistory(){
    const list = $('#notifList'); list.innerHTML='';
    const qs = await getDocs(query(collection(db,'notifications'), orderBy('at','desc')));
    qs.forEach(d=>{
      const n=d.data();
      const hits = (n.to && MAND.id && n.to===MAND.id) || /mandoub/.test(n.roleTarget||'');
      if(!hits) return;
      appendNotifCard(n,false);
    });
  }
  function appendNotifCard(n, prepend=false){
    const list = $('#notifList');
    const dd = n.at?.toDate ? n.at.toDate() : new Date();
    const when = `${dd.getDate()}/${dd.getMonth()+1}/${dd.getFullYear()} â€¢ ${dd.toLocaleTimeString('ar-IQ',{hour:'2-digit',minute:'2-digit'})}`;
    const c = document.createElement('div');
    c.className='card';
    c.innerHTML = `<b>ğŸ”” ${n.title||'ØªÙ†Ø¨ÙŠÙ‡'}</b><br>${n.message||''}<br><small>${n.by||'-'} â€¢ ${when}</small>`;
    prepend ? list.prepend(c) : list.appendChild(c);
  }

  /* ===== Search + Toast ===== */
  function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 2000); }
</script>
</body>
</html>